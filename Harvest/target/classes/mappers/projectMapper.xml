<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itwillbs.mappers.projectMapper">
	<select id="getProjectList" resultType="com.itwillbs.domain.ProjectDTO">
	SELECT *
	  FROM PROJECT_TB
	</select>
	
	<select id="getProjectInfo" resultType="com.itwillbs.domain.ProjectDTO">
		SELECT p.*
			 , case when (SELECT COUNT(*) AS HEARTFILL
			   				FROM LIKE_TB
			  			   WHERE PJ_IDX = P.IDX
							 AND USER_ID = #{SESSIONID}) = 1 THEN 'heart_fill.svg'
			   												 ELSE 'heart.svg' END AS HEART
			 , COALESCE(COUNT(PAY.ID), 0) AS sumUser
			 , COALESCE(SUM(PAY.AMOUNT), 0) AS sumMoney
		  FROM PROJECT_TB P
		  LEFT JOIN PAYMENT_TB PAY
			ON P.IDX = PAY.pj_IDX
		 WHERE P.IDX = #{IDX}
		 GROUP BY p.IDX;
	</select>
	<select id="projectOpen" resultType="com.itwillbs.domain.ProjectDTO">
		SELECT *
  		  FROM PROJECT_TB
 		 WHERE IDX = #{IDX};
	</select>
	
	<select id="getLike" resultType="HashMap" parameterType="HashMap">
		SELECT COUNT(*)  AS CNT
	      FROM LIKE_TB
	     WHERE PJ_IDX = #{PJ_IDX}
	       AND USER_ID = #{USER_ID}
	</select>
	
	<insert id="insertLike" parameterType="HashMap">
		INSERT INTO LIKE_TB 
			 ( IDX
			 , PJ_IDX
			 , USER_ID)
		     VALUES (
		     (SELECT NUM
			    FROM (SELECT IFNULL(MAX(IDX), 0) + 1 AS NUM
					    FROM LIKE_TB) A)
			 , #{PJ_IDX}
		     , #{USER_ID}
		     )
	</insert>
	
	<delete id="delLike" parameterType="HashMap">
		DELETE FROM LIKE_TB
	     WHERE PJ_IDX = #{PJ_IDX}
	       AND USER_ID = #{USER_ID}
	</delete>
	
<!-- 	<select id="getSumMoney" resultType="java.lang.Integer"> -->
<!-- 		SELECT SUM(AMOUNT) AS sumMoney -->
<!-- 	  	  FROM PAYMENT_TB -->
<!-- 	  	 WHERE PJ_IDX = #{IDX} -->
<!-- 	</select> -->
	
<!-- 	<select id="getSumUser" resultType="java.lang.Integer"> -->
<!-- 		SELECT COUNT(ID) AS sumUser -->
<!-- 		  FROM PAYMENT_TB -->
<!-- 		 where PJ_IDX = #{IDX}; -->
<!-- 	</select> -->
</mapper>